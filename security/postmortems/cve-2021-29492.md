# Security postmortem for CVE-2021-29492

## Incident date(s)

2021-01-20 - 2021-05-11

## Authors

yavlasov@google.com

## Status

Draft

## Summary

An external researcher Ruilin Yang (ruilin.yrl@gmail.com) has reported vulnerability against Istio based products
that allowed an adversary to bypass Role Based Access Controls (RBAC) when configured to use URL paths. RBAC is 
a component of Envoy. This class of vulnerabilities is commonly referred to as "path confusion". This was not the
first vulnerability of this kind reported against RBAC, however previous vulnerabilities had existing mitigations
through Envoy's path normalization controls [normalize_path](https://www.envoyproxy.io/docs/envoy/v1.18.2/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-normalize-path)
and [merge_slashes](https://www.envoyproxy.io/docs/envoy/v1.18.2/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-merge-slashes).

The newly reported vulnerability has shown that Envoy does not decode escaped slash sequences %2F and %5C in HTTP 
URL paths in Envoy versions 1.18.2 and earlier. A remote attacker may craft a path with escaped slashes (for example,
/something%2F..%2Fadmin), to bypass access control (for example, a block on /admin). A backend server could then decode
slash sequences and normalize the path to provide an attacker access beyond the scope provided for by the access control
policy.

Unescaping %2F or %5C is not [RFC 3986](https://datatracker.ietf.org/doc/html/rfc3986#section-6) compliant. However HTTP
implementations that unescape slash characters in URL paths are not uncommon.

## CVE advisory

https://github.com/envoyproxy/envoy/security/advisories/GHSA-4987-27fx-x6cf

## Root Causes

This vulnerability was not a result of a defect but rather the lack of clear documentation about effects of Envoy's
and back end services path normalizations on security properties of Envoy's authorization
components such as RBAC or jwt_authn. As a result customers had deployments with configuration and environment that
could not support the desired access control policy. This led to bypasses of access control policy that were possible in
these deployments to be reported as Istio (and by extension Envoy) security vulnerabilities.

## Resolution

It has to be noted that addressing the entire class of path confusion vulnerabilities in Envoy is not practical as it
requires implementation of URL path normalizations that various back end servers perform. As such the reported vulnerability
was addressed by combination of updating public documentation to clarify the requirements for secure deployment of URL path
based access control as well as adding path normalization option for unescaping slash characters.

Updating documentation precludes future treatment of deployments that do not meet requirements for secure path based
access control as security vulnerabilities.

The option of decoding escaped slashes in Envoy path normalizations was added to avoid exposing customers with unsecure
deployments to 0 day exploits.

Furthermore a new mechanism was introduced to Envoy URL path normalizations. It is now possible to reject or redirect
requests when the normalized path differs from the original path. Redirecting requests to the normalized path allows
the client and all downstream intermediaries to operate on consistent URL path representation.

The following patch was provided: https://github.com/envoyproxy/envoy/commit/5333b928d8bcffa26ab19bf018369a835f697585

## Detection

An external researcher Ruilin Yang (ruilin.yrl@gmail.com) has reported vulnerability against Istio based products in
private disclosure.

## Action Items

https://github.com/envoyproxy/envoy/issues?utf8=%E2%9C%93&q=is%3Aissue+%22Action+item+for+CVE-2021-29492%22

## Lessons Learned

Matching URL paths is error prone due to the diversity of path normalizations in HTTP implementations. The only way to
guarantee correctness of URL path matching and by extension security invariants of Envoy's authorization components
is to ensure that Envoy path normalization matches upstream server's exactly. This requirement needs to be clearly
documented such that operators may make informed decisions on how Envoy's path normalization should be configured.

New proto field IDs have to be reserved in the open repo, if the patch adds new fields to proto configuration.
This will prevent developers from committing changes with field IDs used by the patch (checklist updated).

### What went well

*  Envoy's vulnerability response process went problem free.
*  Envoy's path normalization was easy to extend.

### What went wrong

*  Lack of documentation caused a feature request to be treated as a vulnerability.
*  The first patch has to be updated because of collision of proto field IDs in OSS and private patch repositories. 

### Where we got lucky

*  There were no reports of active exploits.

## Timeline

All times US/Pacific

2021-01-20:
* A bypass of RBAC security policy using encoded slashes was privately reported to the Istio security team.

2021-03-04:
* Google's internal Envoy Platform Team was notified about the bypass.

2021-03-25:
* Design specification for unescaping slashes was sent out for comment to the OSS Envoy Security Team.
* Public release date was set to 2021-05-11.

2021-04-01:
* First version of patches was uploaded to the private Envoy repository.

2021-04-19:
* Patches had to be updated due to conflict in proto field IDs between private and open repositories.
* Distributors notified of the upcoming security patch.

2021-04-20:
* Patches sent to Envoy distributors.

2021-05-11:
* CVE publicly disclosed.


## Supporting information

* GutHub advisory: https://github.com/envoyproxy/envoy/security/advisories/GHSA-4987-27fx-x6cf
