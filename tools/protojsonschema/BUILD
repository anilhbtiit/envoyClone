load("@aspect_bazel_lib//lib:jq.bzl", "jq")
load("@aspect_bazel_lib//lib:write_source_files.bzl", "write_source_files")
load("@rules_proto_grpc//:defs.bzl", "proto_plugin")
load(":generate.bzl", "jsonschema_compile")
load(":protos.bzl", "PROTOS")

licenses(["notice"])  # Apache 2


genquery(
    name = "proto_targets_txt",
    expression = """filter(
        @envoy_api:*,
        kind(
            proto_library,
            filter(
                pkg$,
                deps(@envoy_api//:all_protos)
            )
        )
    )""",
    scope = ["@envoy_api//:all_protos"],
)

jq(
    name = "proto_targets",
    srcs = [
        ":proto_targets_txt",
    ],
    args = ["-rsR"],
    filter = """
    "# Generated by bazel run //tools/protojsonschema:proto_targets, DO NOT EDIT.\n\n"+
    "PROTOS = [\n\t" + (split("\n") | map(select(length>0)) | map("\\""+.+"\\"") | join(",\n\t")) + ",\n]"
    """,
)

# to generate the "protos.bzl" file, use "bazel run //tools/protojsonschema:write_proto_targets"
# if file have differed from what already exist, "bazel run //tools/protojsonschema:write_proto_targets_tests" will throw an error
write_source_files(
    name = "write_proto_targets",
    files = {
        "protos.bzl": ":proto_targets",
    },
)

proto_plugin(
    name = "protoc_gen_jsonschema_proto_plugin",
    options = [
        "--jsonschema_opt=file_extension=schema.json",
        "--jsonschema_opt=debug",
    ],
    output_directory = True,
    tool = "@com_github_chrusty_protoc_gen_jsonschema//cmd/protoc-gen-jsonschema:protoc-gen-jsonschema",
)

[
    # example: "@envoy_api//contrib/envoy/extensions/filters/http/dynamo/v3:pkg" => "contrib_envoy_extensions_filters_http_dynamo_v3_jsonschema"
    jsonschema_compile(
        name = proto.replace("@envoy_api//", "").replace("/", "_").replace(":pkg", "") + "_jsonschema",
        protos = [proto]
    ) for proto in PROTOS
]
