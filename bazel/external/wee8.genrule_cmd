#!/bin/bash

set -e

# Works on Linux-{x86_64,s390x,aarch64,ppc64le}, macOS-{x86_64,arm64} and Windows-x86_64.
ARCH="$$(uname -m)"
SYSTEM="$$(uname -s)"
PLATFORM="$${SYSTEM}-$${ARCH}"

case $${PLATFORM} in
Linux-x86_64|Linux-s390x|Linux-aarch64|Linux-ppc64le)
  ;;
Darwin-x86_64|Darwin-arm64)
  ;;
MSYS_NT-*-x86_64)
  ;;
*)
  echo "ERROR: wee8 is currently not supported on $${PLATFORM}." >&2
  exit 1
esac

# Bazel magic.
ROOT=$$(dirname $$(dirname $(rootpath include/js_protocol.pdl)))
pushd $$ROOT

# Clean after previous build.
rm -rf out/wee8

# Select gn tool for the current platform.
if [[ -f /etc/centos-release ]] && [[ $$(cat /etc/centos-release) =~ "CentOS Linux release 7" ]] && [[ -x "$$(command -v gn)" ]]; then
  # Use system default on CentOS 7, as it has an old version of GLIBC which is otherwise incompatible with the prebuilt binary.
  gn=$$(command -v gn)
elif [[ $${PLATFORM} == "Darwin-x86_64" ]]; then
  gn=buildtools/mac/gn
elif [[ $${PLATFORM} == "Darwin-arm64" ]]; then
  gn=buildtools/mac-arm64/gn
elif [[ $${PLATFORM} == "Linux-x86_64" ]]; then
  gn=buildtools/linux64/gn
elif [[ $${PLATFORM} == "Linux-aarch64" ]]; then
  gn=buildtools/linux-arm64/gn
elif [[ $${PLATFORM} == MSYS_NT-*-x86_64 ]]; then
  gn=buildtools/win/gn.exe
else
  # Fallback to system default.
  gn=$$(command -v gn)
fi

# Select ninja tool for the current platform.
if [[ $${SYSTEM} == "Darwin" ]]; then
  ninja=third_party/depot_tools/ninja-mac
elif [[ $${PLATFORM} == "Linux-x86_64" ]]; then
  ninja=third_party/depot_tools/ninja-linux64
elif [[ $${PLATFORM} == MSYS_NT-*-x86_64 ]]; then
  ninja=third_party/depot_tools/ninja.exe
else
  # Fallback to system default.
  ninja=$$(command -v ninja)
fi

# Fix for building from a tarball without some unnecessary components.
WEE8_BUILD_ARGS+=" v8_enable_i18n_support=false"
WEE8_BUILD_ARGS+=" use_sysroot=false"
WEE8_BUILD_ARGS+=" use_glib=false"

# Use locally installed toolchain on Windows.
if [[ $${SYSTEM} == *MSYS_NT* ]]; then
  export DEPOT_TOOLS_WIN_TOOLCHAIN=0
fi

# Generate inspector files.
"$$gn" gen out/wee8 --args="$$WEE8_BUILD_ARGS"
"$$ninja" -C out/wee8 src/inspector:protocol_generated_sources

# Move generated files to the expected destinations.
popd
mv $$ROOT/out/wee8/gen/include/inspector/* $(@D)/include/inspector/
mv $$ROOT/out/wee8/gen/src/inspector/protocol/* $(@D)/src/inspector/protocol/
