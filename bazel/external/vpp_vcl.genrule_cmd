#!/bin/bash

set -e

# This works only on Linux.
if [[ `uname` != "Linux" ]]; then
  echo "ERROR: VPP VCL is currently supported only on Linux"
  exit 1
fi

# Bazel magic.
ROOT=$$(dirname $(rootpath src/CMakeLists.txt))/..

echo "ROOT $$ROOT"
pushd $$ROOT

# Handle extra dependencies
pip3 install ply

# Build
cmake --version
ninja --version

mkdir _vcl
cmake -G Ninja -S src/ -B _vcl -DCMAKE_INSTALL_PREFIX=_vcl -DCMAKE_BUILD_TYPE:STRING=release
ninja -C _vcl vppcom

popd

# Move compiled libraries to the expected destinations.
mv $$ROOT/_vcl/CMakeFiles/vcl/libvppcom.a $(execpath libvppcom.a)
mv $$ROOT/_vcl/CMakeFiles/vppinfra/libvppinfra.a $(execpath libvppinfra.a)
mv $$ROOT/_vcl/CMakeFiles/svm/libsvm.a $(execpath libsvm.a)
mv $$ROOT/_vcl/CMakeFiles/vlibmemory/libvlibmemoryclient.a $(execpath libvlibmemoryclient.a)
